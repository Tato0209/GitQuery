/* SELECT FROM "OPRQ" T0 WHERE T0."CreateDate" BETWEEN [%0] AND [%1] ;*/

CALL "FlujodeAutorizacionOCPorFechas" ([%0],[%1],FLUJOAUTORIZACIONOC);

SELECT DISTINCT D0."DocNum" "NRO SOLICITUD COMPRA",
D0."CreateDate" "FECHA CREACIÓN SOLICITUD COMPRA",
DM2."ItmsGrpNam" "GRUPO DE ARTICULOS",
D0."ReqName" "SOLICITANTE COMPRA", 

CASE WHEN D1."LineStatus"='C' THEN 'Cerrado' 
WHEN D1."LineStatus"='O' THEN 'Abierto' END "ESTADOLINEASOLICITUDCOMPRA",

D1."VisOrder"+1 "LINEASOLICITUDCOMPRA",
D1."ItemCode" "ARTICULO",
D1."Dscription" "DESCRIPCIÓN",
D1."Quantity" "CANTIDADSOLICITUD",
D1."unitMsr" "UMSOLICITUD",
D0."Comments" "COMENTARIOSOLICITUD",
D1."OcrCode" "CC1",
D1."OcrCode2" "CC2",
D1."OcrCode3" "CC3",
D1."OcrCode4" "CC4",
D1."OcrCode5" "CC5",
D1."Project" "PROYECTO",
DMSD."U_CL_COMPRADOR" "COMPRADOR POR DEFECTO",
DFLUJO."NUMEROBORRADOR" "NROPRELIMINAROC" ,
DFLUJO."ESTADOOC" "ESTADOPRELIMINAROC",
DFLUJO."CANTIDAD" "CANTIDADPRELIMINAROC",
DFLUJO."PROVEEDOR" "PROVEEDORPRELIMINAROC",
DFLUJO."COMPRADOR" "COMPRADORPRELIMINAROC",
DFLUJO."JENIFERBONELLI" "ESTADO JENIFER BONELLI",
DFLUJO."ALEJANDRAEGUSQUIZA" "ESTADO ALEJANDRA EGUSQUIZA",
DFLUJO."MARISOLHADDAD" "ESTADO MARISOL HADDAD",
DFLUJO."ALFREDOCARHUAMACA" "ESTADO ALFREDO CARHUAMACA",
DFLUJO."DAVIDACHANCARAY" "ESTADO DAVID ACHANCARAY", 
DFLUJO."GUSTAVOJO" "ESTADO GUSTAVO JO",
D2."DocNum" "NRO OC",
D2."CreateDate" "FECHA CREACION OC",
D3."ShipDate" "FECHA ENTREGA LINEA",
D3."U_CL_NUEVAFECHAENTREGA" "FECHA ENTREGA LINEA MODIFICADA",
D3."U_MSS_CMN" "COMENTARIO FECHA",
D2."CardCode" "CÓDIGO PROVEEDOR",
D2."CardName" "NOMBRE PROVEEDOR",
DMU."U_NAME" "USUARIO COMPRADOR OC",
D2."Comments" "COMENTARIO OC",
DMCP."PymntGroup" "CONDICION DE PAGO",
D2."DocCur" "MONEDA OC",
D3."Quantity" "CANTIDAD LINEA OC",
D2."DocRate" "T/C",
D3."OpenSum" "PU S/",
D3."OpenSumFC" "PU $",
D3."LineTotal" "PT S/",
D3."TotalFrgn" "PT $",

CASE WHEN D3."LineStatus"='C' THEN 'Cerrado' 
WHEN D3."LineStatus"='O' THEN 'Abierto'
WHEN D2."CANCELED"='Y' THEN 'Cancelado'
 END "ESTADOLINEAOC",

D6."DocNum" "NÚMERO ENTRADA",
D6."DocDate"  "FECHA CONTABLE ENTRADA",
D5."Quantity" "CANTIDAD ENTRADA",
D5."WhsCode"  "ALMACEN ENTRADA",
DM3."WhsName"  "NOMBRE ALMACEN ENTRADA",
						
D6."NumAtCard"  "GR ENTRADA",

T0."U_BPV_NCON2"  "T1 GR ENVÍO",
T1."DocDate"  "T1 FECHA CONTABLE ENVÍO",
T0."DocNum"  "T1 NÚMERO TRANSFERENCIA",
T1."U_CL_CLAVEB"   "T1 CLAVE BASE",
T1."U_CL_LINEAB"+1   "T1 LINEA BASE",
 
T2."DocDate"  "T2 FECHA CONTABLE RECEPCIÓN",
T2."DocNum"   "T2 NÚMERO TRANSFERENCIA",
--T3."U_CL_CLAVEB"   "T2 CLAVE BASE",
--T3."U_CL_LINEAB"+1  "T2 LINEA BASE",
T3."WhsCode"  "ALMACEN FINAL",
DM4."WhsName" "NOMBRE ALMACEN FINAL" 
 
FROM "OPRQ" D0 
INNER JOIN "PRQ1" D1 ON  D0."DocEntry"=D1."DocEntry" 
LEFT OUTER JOIN :FLUJOAUTORIZACIONOC DFLUJO ON D1."DocEntry"=DFLUJO."BASEENTRYOC" AND D1."LineNum"=DFLUJO."BASELINEOC"

INNER JOIN "OITM" "DM1" ON D1."ItemCode" =DM1."ItemCode"
INNER JOIN "OITB" "DM2" ON DM1."ItmsGrpCod"=DM2."ItmsGrpCod"
LEFT OUTER JOIN "POR1" D3 ON D3."BaseEntry"=D1."DocEntry" AND D3."BaseType"=D1."ObjType" AND  D3."BaseLine"=D1."LineNum"
LEFT OUTER JOIN "OPOR" D2 ON D2."DocEntry"=D3."DocEntry"
LEFT OUTER JOIN "OUSR" DMU ON D2."UserSign"=DMU."USERID"
LEFT OUTER JOIN "OCTG" DMCP ON D2."GroupNum"=DMCP."GroupNum" 
LEFT OUTER JOIN "@CL_OSDI" DMSD ON DM1."U_CL_CODLIN"=DMSD."Code"

LEFT OUTER JOIN "PDN1" D5 ON D5."BaseEntry"=D3."DocEntry" AND D5."BaseType"=22 AND  D5."BaseLine"=D3."LineNum" 
AND ((SELECT "CANCELED" FROM "OPDN" WHERE "DocEntry"=D5."DocEntry")='N')
LEFT OUTER JOIN "OPDN" D6 ON D5."DocEntry"=D6."DocEntry" 
LEFT OUTER JOIN "OWHS" DM3 ON D5."WhsCode"=DM3."WhsCode"


LEFT OUTER JOIN "WTR1" T1 ON T1."U_CL_CLAVEB"= D5."DocEntry" AND T1."U_CL_LINEAB"=D5."LineNum" 
AND T1."WhsCode" LIKE 'T%' AND T1."LineStatus"='O' AND T1."Quantity">0
LEFT OUTER JOIN  "OWTR" T0 ON T1."DocEntry"=T0."DocEntry"

LEFT OUTER JOIN "WTR1" T3 ON  T3."FromWhsCod" LIKE 'T%' AND T3."LineStatus"='O' AND T3."Quantity">0
AND (SELECT "U_CL_BASETYPE" FROM "OWTR" WHERE "DocEntry"=T3."DocEntry")='67' 
AND (SELECT "U_CL_BASEENTRY" FROM "OWTR" WHERE "DocEntry"=T3."DocEntry")=T1."DocEntry"

LEFT OUTER JOIN  "OWTR" T2 ON T3."DocEntry"=T2."DocEntry"
LEFT OUTER JOIN "OWHS" DM4 ON T3."WhsCode"=DM4."WhsCode"

WHERE 

D0."CANCELED"='N'

AND 

DM1."InvntItem"='Y' 

AND
--(D0."CreateDate" BETWEEN '20240601' AND '20241231')
(D0."CreateDate" BETWEEN [%0] AND  [%1] )

ORDER BY D0."DocNum",D1."VisOrder"+1 ASC;